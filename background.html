<!DOCTYPE html>
<html>
<head>
<script src="alum.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">

////////////////////////////////////////////////////////////////////////////////
// Global data

var SlotMap = {};  // number -> Slot
var WindowMap = {};  // windowId -> Slot
var Rotating = false;

// Preferences.
var RotateRight = {};
var RotateLeft = {};
var OpenAll = {};

////////////////////////////////////////////////////////////////////////////////
// Init/event handling
function handleBrowserAction(tab) {
  console.log("Browser action clicked!");
  openAllWindows();
}

function openAllWindows(event) {
  var columns = localStorage.getItem("config:columns");
  var rows = localStorage.getItem("config:rows");
  var savedSlots = JSON.parse(localStorage.getItem("config:savedSlots"));
  var width = window.screen.availWidth;
  var height = window.screen.availHeight;
  // TODO: Adjust for any menu bars or not visible area at the top of the screen.
  var offsetX = window.screen.width - width;
  var offsetY = window.screen.height - height;
  var columnWidth = (1.0 * width) / columns;
  var rowHeight = (1.0 * height) / rows;

  var current = 0;
  function openSlot(next) {
    if (next >= savedSlots.length) return;
    var slot = savedSlots[next];
    chrome.windows.create({
      left: offsetX + Math.floor(slot.x * columnWidth),
      top: offsetY + Math.floor(slot.y * rowHeight),
      width: Math.floor(slot.width * columnWidth),
      height: Math.floor(slot.height * rowHeight)
    }, function(window) {
      Slot.set(new Slot(next, window.id));
      openSlot(next + 1);
    });
  }
  openSlot(0);
}

function handleHotKey(event) {
  var pressed = getPressedKeys(event);
  if (objectsEqual(pressed, OpenAll)) {
    openAllWindows();
  } else if (objectsEqual(pressed, RotateRight)) {
    Slot.rotate(true);
  } else if (objectsEqual(pressed, RotateLeft)) {
    Slot.rotate(false);
  }
}

function loadPreferences() {
  RotateRight = loadHotkeyConfig("rotateleft-keys");
  RotateLeft = loadHotkeyConfig("rotateright-keys");
  OpenAll = loadHotkeyConfig("openall-keys");

  // Set defaults on first load.
  if (!localStorage.getItem("config:columns")) {
    localStorage.setItem("config:columns", 4);
  }
  if (!localStorage.getItem("config:rows")) {
    localStorage.setItem("config:rows", 3);
  }
  if (!localStorage.getItem("config:savedSlots")) {
    localStorage.setItem(
        "config:savedSlots",
        JSON.stringify([
          {"x":0,"y":0,"width":2,"height":3},
          {"x":2,"y":0,"width":2,"height":3}
        ]));
  }
}

function assignBadge(tabId, windowId) {
  var slot = WindowMap[windowId];
  if (!slot) return;
  var number = slot.number + 1;
  console.log("Assigning badge for " + number);
  chrome.browserAction.setBadgeText({
    "text": "" + number,
    "tabId": tabId,
  });
  chrome.browserAction.setTitle({
    "title": "Alum window #" + number,
    "tabId": tabId,
  });
}

function handleRemoveWindow(windowId) {
  Slot.removeWindow(windowId);
}

function initAlum() {
  loadPreferences();

  chrome.browserAction.onClicked.addListener(function(tab) {
    handleBrowserAction(tab);
  });
  chrome.extension.onRequest.addListener(function(request, sender, unused) {
    handleHotKey(request);
  });
  chrome.windows.onRemoved.addListener(function(windowId) {
    handleRemoveWindow(windowId);
  });
  chrome.tabs.onAttached.addListener(function(tabId, attachInfo) {
    assignBadge(tabId, attachInfo.newWindowId);
  });
  chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
    if (changeInfo.status == "complete") {
      assignBadge(tabId, tab.windowId);
    }
  });
}

</script>
</head>
<body onload="initAlum();">
</body>
</html>
