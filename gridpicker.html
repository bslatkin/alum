<html>
<head>
<title>Alum options</title>
<style type="text/css">

h1 {
  font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
}

.slot {
  cursor: move;
  border: 0;
  padding: 0;
  marign: 0;
}

.slot-static {
  z-index: 1;
}

.slot-dragging {
  z-index: 10000;
}

#gridcontainer {
  margin: 10px;
  padding: 0;
  border: 2px dashed #aaa;
}

#shelfcontainer {
  margin: 10px;
  padding-top: 280px;
  font: -webkit-small-control;
}

#newbutton {
  padding: 20px;
  margin-right: 1.5em;
}

#gridwidth {
  width: 2.5em;
  margin-right: 1.5em;
}

#gridheight {
  width: 2.5em;
}

#setgridbutton {
  padding: 7px;
  margin-left: 1.5em;
}

</style>

<link type="text/css" href="jquery/css/smoothness/jquery-ui-1.7.2.custom.css" rel="stylesheet" />	
<script type="text/javascript" src="jquery/js/jquery-1.3.2.min.js"></script>
<script type="text/javascript" src="jquery/js/jquery-ui-1.7.2.custom.min.js"></script>

<script type="text/javascript">
  // inputs
  var diagramWidth = 500;
  var diagramHeight = 250;
  var numColumns = 4;
  var numRows = 3;
  var gridWidth = Math.floor(diagramWidth / numColumns);
  var gridHeight = Math.floor(diagramHeight / numRows);
  // Readjust total layout size for weight floating point values.
  diagramWidth = numColumns * gridWidth;
  diagramHeight = numRows * gridHeight;
  var gridColumns = [];

  // Convert grid slot to pixel location.
  function gridPixelsX(x) {
    return (gridWidth) * x;
  }
  function gridPixelsY(y) {
    return (gridHeight) * y;
  }

  // Convert pixel location to grid slots. Returns [{x: N, y: M}, ...]
  function getGridSlots(top, left, bottom, right) {
    var foundSlots = [];
    for (var x = 0; x < numColumns; ++x) {
      for (var y = 0; y < numRows; ++y) {
        var pixelX = gridPixelsX(x);
        var pixelY = gridPixelsY(y);
        if (bottom >= pixelY &&
            top <= pixelY &&
            right >= pixelX &&
            left <= pixelX) {
          console.log("pixelxy=" + pixelX + "," + pixelY + " to: " +
                      "left=" + left + " top=" + top +
                      " right=" + right + " bottom=" + bottom +
                      "; overlapping: x=" + x + ", y=" + y);
          foundSlots.push({"x": x, "y": y});
        }
      }
    }
    return foundSlots;
  }

  ///// Event handling
  function startDragOrResize(event, ui) {
    ui.helper.addClass("slot-dragging")
        .addClass("ui-state-active")
        .removeClass("slot-static");
  }
  function stopDragOrResize(event, ui) {
    var position = ui.helper.position();
    ui.helper.addClass("slot-static")
        .removeClass("slot-dragging")
        .removeClass("ui-state-active");
    var gridSlots = getGridSlots(
        position.top,
        position.left,
        position.top + ui.helper.innerHeight(),
        position.left + ui.helper.innerWidth());

    // Clear the old positions this item overlapped.
    var oldSlots = ui.helper.data("overlap");
    for (var i = 0; i < oldSlots.length; ++i) {
      var overlap = oldSlots[i];
      gridColumns[overlap.x][overlap.y] = null;
    }

    // Remove/hide items in overlapped slots and point at the new one.
    for (var i = 0; i < gridSlots.length; ++i) {
      var newOverlap = gridSlots[i];
      var slot = gridColumns[newOverlap.x][newOverlap.y];
      if (slot) {
        // Remove *all* slots this single element overlaps.
        var slotOverlaps = slot.data("overlap");
        for (var j = 0; j < slotOverlaps.length; ++j) {
          var itemOverlap = slotOverlaps[j];
          var itemSlot = gridColumns[itemOverlap.x][itemOverlap.y];
          if (itemSlot) {
            gridColumns[itemOverlap.x][itemOverlap.y] = null;
            if (j == 0) {
              // The first item slot removal will be animated.
              slot.hide("puff", {}, 200, function() {
                $(this).remove();  // Clean up the dom.
                console.log("Removing: " + $(this).text());
              });
            }
          }
        }
      }
      gridColumns[newOverlap.x][newOverlap.y] = ui.helper;
    }

    // Save the new locations to clear it the next time the object is changed.
    ui.helper.data("overlap", gridSlots);
  }

  function createSlot(x, y) {
    var slot = $("<div>" + x + ", " + y + "</div>");
    slot.addClass("slot")
        .addClass("slot-static")
        .addClass("ui-state-default")
        .data("overlap", [{"x": x, "y": y}])
        .css({"width": (gridWidth-2) + "px",
              "height": (gridHeight-2) + "px",
              "left": gridPixelsX(x),
              "top": gridPixelsY(y),
              "position": "absolute"})
        .draggable({"grid": [gridWidth, gridHeight],
                    "containment": "parent",
                    "zIndex": 0,
                    "start": startDragOrResize,
                    "stop": stopDragOrResize})
        .resizable({"grid": [gridWidth, gridHeight],
                    "minWidth": gridWidth,
                    "minHeight": gridHeight,
                    "maxWidth": diagramWidth,
                    "maxHeight": diagramHeight,
                    "containment": "parent",
                    "start": startDragOrResize,
                    "stop": stopDragOrResize})
        .appendTo("#gridcontainer");
    return slot;
  }

  function resetGrid(columns, rows) {
    numRows = rows;
    numColumns = columns;
    gridColumns = [];
    gridWidth = Math.floor(diagramWidth / numColumns);
    gridHeight = Math.floor(diagramHeight / numRows);
    // Readjust total layout size for weight floating point values.
    diagramWidth = numColumns * gridWidth;
    diagramHeight = numRows * gridHeight;

    var children = $("#gridcontainer").children(".slot");
    for (var i = 0; i < children.length; ++i) {
      $(children[i]).remove();
    }

    $("#gridcontainer").css({"width": diagramWidth,
                             "height": diagramHeight,
                             "position": "absolute"});

    for (var x = 0; x < numColumns; ++x) {
      var row = []
      gridColumns[x] = row;
      for (var y = 0; y < numRows; ++y) {
        slot = createSlot(x, y);
        row[y] = slot;
      }
    }
  }

  $(document).ready(function() {
    // TODO: Save and restore preference with local storage API!
    // Create a grid of draggables.
    resetGrid(numRows, numColumns);

    // Create a new window button.
    $("<button id='newbutton' type='submit'>Add Window</button>")
        .addClass("ui-state-default")
        .addClass("ui-corner-all")
        .addClass("ui-priority-primary")
        .hover(function() {
          $(this).addClass("ui-state-hover");
        }, function() {
          $(this).removeClass("ui-state-active")
                 .removeClass("ui-state-hover");
        })
        .mousedown(function() {
          $(this).addClass("ui-state-active");
        })
        .click(function() {
          if ($(this).hasClass("ui-state-active")) {
            $(this).removeClass("ui-state-active");
            for (var x = 0; x < numColumns; ++x) {
              for (var y = 0; y < numRows; ++y) {
                if (gridColumns[x][y] == null) {
                  gridColumns[x][y] = createSlot(x, y);
                  return false;
                }
              }
            }
          }
        })
        .prependTo("#shelfcontainer");

    // Add Grid setting button.
    $("<button id='setgridbutton' type='submit'>Reset Grid</button>")
        .addClass("ui-state-default")
        .addClass("ui-corner-all")
        .addClass("ui-priority-primary")
        .hover(function() {
          $(this).addClass("ui-state-hover");
        }, function() {
          $(this).removeClass("ui-state-active")
                 .removeClass("ui-state-hover");
        })
        .mousedown(function() {
          $(this).addClass("ui-state-active");
        })
        .click(function() {
          if ($(this).hasClass("ui-state-active")) {
            $(this).removeClass("ui-state-active");
            if (!($("#gridwidth").val() > 0) ||
                !($("#gridheight").val() > 0)) {
              $("<p>Invalid number of columns and rows.</p>").dialog({
                "draggable": false,
                "modal": true,
                "resizable": false,
                "title": "Error"
              });
            } else {
              resetGrid($("#gridwidth").val(),
                        $("#gridheight").val());
            }
            return false;
          }
        })
        .appendTo("#shelfcontainer");
  });
</script>

</head>
<body>

<h1>Alum options</h1>

<div id="gridcontainer"></div>

<div id="shelfcontainer">
  Columns <input id="gridwidth" type="text" value="4" />
  Rows <input id="gridheight" type="text" value="3" />
</div>

</body>
</html>
