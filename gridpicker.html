<html>
<head>

<style type="text/css">

.slot {
  cursor: move;
  border: 1px solid black;
  padding: 0px;
  marign: 0px;
}

.slot-static {
  background-color: #ccc;
  z-index: 1;
}

.slot-dragging {
  background-color: #aaa;
  z-index: 10000;
}

#gridcontainer {
  margin: 0;
  padding: 0px;
  border: 1px solid red;
}

#shelfcontainer {
  padding-top: 280px;
  font: -webkit-small-control;
}

#newbutton {
  padding: 20px;
  margin-right: 1.5em;
}

#gridwidth {
  width: 2.5em;
  margin-right: 1.5em;
}

#gridheight {
  width: 2.5em;
}

#setgridbutton {
  padding: 7px;
  margin-left: 1.5em;
}

</style>

<link type="text/css" href="jquery/css/smoothness/jquery-ui-1.7.2.custom.css" rel="stylesheet" />	
<script type="text/javascript" src="jquery/js/jquery-1.3.2.min.js"></script>
<script type="text/javascript" src="jquery/js/jquery-ui-1.7.2.custom.min.js"></script>

<script type="text/javascript">
  // inputs
  var diagramWidth = 500;
  var diagramHeight = 250;
  var numColumns = 4;
  var numRows = 3;
  var gridWidth = Math.floor(diagramWidth / numColumns);
  var gridHeight = Math.floor(diagramHeight / numRows);
  // Readjust total layout size for weight floating point values.
  diagramWidth = numColumns * gridWidth;
  diagramHeight = numRows * gridHeight;
  var gridColumns = [];

  // Convert grid slot to pixel location.
  function gridPixelsX(x) {
    return (gridWidth) * x;
  }
  function gridPixelsY(y) {
    return (gridHeight) * y;
  }

  // Convert pixel location to grid slots. Returns [{x: N, y: M}, ...]
  function getGridSlots(top, left, bottom, right) {
    var foundSlots = [];
    for (var x = 0; x < numColumns; ++x) {
      for (var y = 0; y < numRows; ++y) {
        var pixelX = gridPixelsX(x);
        var pixelY = gridPixelsY(y);
        if (bottom >= pixelY &&
            top <= pixelY &&
            right >= pixelX &&
            left <= pixelX) {
          console.log("pixelxy=" + pixelX + "," + pixelY + " to: " +
                      "left=" + left + " top=" + top +
                      " right=" + right + " bottom=" + bottom +
                      "; overlapping: x=" + x + ", y=" + y);
          foundSlots.push({"x": x, "y": y});
        }
      }
    }
    return foundSlots;
  }

  ///// Event handling
  function startDragOrResize(event, ui) {
    ui.helper.addClass("slot-dragging").removeClass("slot-static");
  }
  function stopDragOrResize(event, ui) {
    var position = ui.helper.position();
    ui.helper.addClass("slot-static").removeClass("slot-dragging");
    var gridSlots = getGridSlots(
        position.top,
        position.left,
        position.top + ui.helper.innerHeight(),
        position.left + ui.helper.innerWidth());

    // Clear the old positions this item overlapped.
    var oldSlots = ui.helper.data("overlap");
    for (var i = 0; i < oldSlots.length; ++i) {
      var overlap = oldSlots[i];
      gridColumns[overlap.x][overlap.y] = null;
    }

    // Remove/hide items in overlapped slots and point at the new one.
    for (var i = 0; i < gridSlots.length; ++i) {
      var newOverlap = gridSlots[i];
      var slot = gridColumns[newOverlap.x][newOverlap.y];
      if (slot) {
        // Remove *all* slots this single element overlaps.
        var slotOverlaps = slot.data("overlap");
        for (var j = 0; j < slotOverlaps.length; ++j) {
          var itemOverlap = slotOverlaps[j];
          var itemSlot = gridColumns[itemOverlap.x][itemOverlap.y];
          if (itemSlot) {
            gridColumns[itemOverlap.x][itemOverlap.y] = null;
            if (j == 0) {
              // The first item slot removal will be animated.
              slot.hide("puff", {}, 200, function() {
                $(this).remove();  // Clean up the dom.
                console.log("Removing: " + $(this).text());
              });
            }
          }
        }
      }
      gridColumns[newOverlap.x][newOverlap.y] = ui.helper;
    }

    // Save the new locations to clear it the next time the object is changed.
    ui.helper.data("overlap", gridSlots);
  }

  $(document).ready(function() {
    $("#gridcontainer").css({"width": diagramWidth,
                             "height": diagramHeight,
                             "position": "absolute"});

    // Create a grid of draggables.
    for (var x = 0; x < numColumns; ++x) {
      var row = []
      gridColumns[x] = row;
      for (var y = 0; y < numRows; ++y) {
        var slot = $("<div>" + x + ", " + y + "</div>");
        slot.addClass("slot")
            .addClass("slot-static")
            .data("overlap", [{"x": x, "y": y}])
            .css({"width": (gridWidth-2) + "px",
                  "height": (gridHeight-2) + "px",
                  "left": gridPixelsX(x),
                  "top": gridPixelsY(y),
                  "position": "absolute"})
            .draggable({"grid": [gridWidth, gridHeight],
                        "containment": "parent",
                        "zIndex": 0,
                        "start": startDragOrResize,
                        "stop": stopDragOrResize})
            .resizable({"grid": [gridWidth, gridHeight],
                        "minWidth": gridWidth,
                        "minHeight": gridHeight,
                        "maxWidth": diagramWidth,
                        "maxHeight": diagramHeight,
                        "containment": "parent",
                        "start": startDragOrResize,
                        "stop": stopDragOrResize})
            .appendTo("#gridcontainer");
        row[y] = slot;
      }
    }

    // Create a new window button.
    $("<button id='newbutton' type='submit'>New Window</button>")
        .addClass("ui-state-default")
        .addClass("ui-corner-all")
        .addClass("ui-priority-primary")
        .hover(function() {
          $(this).addClass("ui-state-hover");
        }, function() {
          $(this).removeClass("ui-state-active")
                 .removeClass("ui-state-hover");
        })
        .mousedown(function() {
          $(this).addClass("ui-state-active");
        })
        .click(function() {
          if ($(this).hasClass("ui-state-active")) {
            $(this).removeClass("ui-state-active");
            // Create a new window in the first open slot.
            // TODO
          }
        })
        .prependTo("#shelfcontainer");

    // Add Grid setting button.
    $("<button id='setgridbutton' type='submit'>Set Grid</button>")
        .addClass("ui-state-default")
        .addClass("ui-corner-all")
        .addClass("ui-priority-primary")
        .hover(function() {
          $(this).addClass("ui-state-hover");
        }, function() {
          $(this).removeClass("ui-state-active")
                 .removeClass("ui-state-hover");
        })
        .mousedown(function() {
          $(this).addClass("ui-state-active");
        })
        .click(function() {
          if ($(this).hasClass("ui-state-active")) {
            $(this).removeClass("ui-state-active");
            // Update the grid
            // TODO
          }
        })
        .appendTo("#shelfcontainer");
  });
</script>

</head>
<body>

<!-- list on the right to select the different numbers -->
<!-- dialog to change the numbers of each with a button -->

<div id="gridcontainer"></div>

<div id="shelfcontainer">
  Width <input id="gridwidth" type="text" />
  Height <input id="gridheight" type="text" />
</div>

</body>
</html>
